<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ® Romany Score</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; }
    h1 { margin: 10px 0; }
    .top-players { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
    .card { background: white; padding: 10px 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    table { width: 90%; margin: 20px auto; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    button { margin: 5px; padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { opacity: 0.9; }
    .btn { background: #007bff; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-edit { background: #ffc107; color: black; font-size: 12px; padding: 2px 6px; }
    .wins-table { width: 50%; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>ğŸ¯ Romany Score</h1>

  <div>
    <label>ğŸ² Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø©: 
      <select id="gameSelect">
        <option>Ø¯ÙˆÙ…ÙŠÙ†Ùˆ</option>
        <option>Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</option>
        <option>Ø§Ù„Ø´Ø·Ø±Ù†Ø¬</option>
        <option>Ù„Ø¹Ø¨Ø© Ø§Ù„ÙˆØ±Ù‚</option>
      </select>
    </label>
    <br>
    <label>ğŸ‘¥ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: 
      <select id="playersSelect" multiple>
        <option>Ø±ÙˆÙ…Ø§Ù†ÙŠ</option>
        <option>Ø¹Ø¨ÙŠØ±</option>
        <option>Ø¬ÙˆØ±Ø¬</option>
        <option>Ù†Ø±Ù…ÙŠÙ†</option>
        <option>Ù‡Ø§Ù†ÙŠ</option>
        <option>Ù†ÙŠØ¨Ø§Ù„</option>
        <option>Ø´Ù†ÙˆØ¯Ù‡</option>
        <option>Ù‡Ù†Ø§Ø¡</option>
      </select>
    </label>
    <br>
    <button class="btn" onclick="startNewGame()">ğŸ® Ø¨Ø¯Ø¡ Ø¬ÙŠÙ… Ø¬Ø¯ÙŠØ¯</button>
    <button class="btn-danger" onclick="endGame()">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙŠÙ…</button>
  </div>

  <div class="top-players" id="topPlayers"></div>

  <table id="scoreTable">
    <thead id="scoreHead"></thead>
    <tbody id="scoreBody"></tbody>
  </table>

  <h2>ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ÙÙˆØ²</h2>
  <table class="wins-table" id="winsTable">
    <thead>
      <tr><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ²</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAxAwhJzFIAbtR7cbyAbFevEvb_lVY20Ok",
      authDomain: "romanyscore.firebaseapp.com",
      databaseURL: "https://romanyscore-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "romanyscore",
      storageBucket: "romanyscore.firebasestorage.app",
      messagingSenderId: "536853744178",
      appId: "1:536853744178:web:3dc612a4ed90cf3f210a2b",
      measurementId: "G-EXGMHF3GL4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentGameId = null;
    let players = [];
    let wins = {};

    // Ø¨Ø¯Ø¡ Ø¬ÙŠÙ… Ø¬Ø¯ÙŠØ¯
    function startNewGame() {
      const gameName = document.getElementById("gameSelect").value;
      const selectedPlayers = Array.from(document.getElementById("playersSelect").selectedOptions).map(o => o.value);

      if (selectedPlayers.length < 2) {
        alert("Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");
        return;
      }

      const gamesRef = ref(db, "games");
      const newGameRef = push(gamesRef);

      currentGameId = newGameRef.key;
      players = selectedPlayers;

      set(newGameRef, {
        gameName,
        players,
        rounds: [],
        finished: false,
        createdAt: Date.now()
      });
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    function addRound() {
      if (!currentGameId) return;
      const scores = {};
      players.forEach(p => {
        const val = document.getElementById(`input-${p}`).value;
        scores[p] = val ? parseInt(val) : 0;
      });

      const roundRef = ref(db, `games/${currentGameId}/rounds`);
      push(roundRef, scores);
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø¬ÙˆÙ„Ø©
    function editRound(roundId, oldScores) {
      if (!currentGameId) return;
      const newScores = {};
      players.forEach(p => {
        const val = prompt(`ØªØ¹Ø¯ÙŠÙ„ ${p}`, oldScores[p]);
        newScores[p] = val ? parseInt(val) : 0;
      });

      update(ref(db, `games/${currentGameId}/rounds/${roundId}`), newScores);
    }

    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙŠÙ…
    function endGame() {
      if (!currentGameId) return;
      update(ref(db, `games/${currentGameId}`), { finished: true });

      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ§Ø¦Ø²
      const totals = {};
      players.forEach(p => totals[p] = 0);
      const roundsRef = ref(db, `games/${currentGameId}/rounds`);
      onValue(roundsRef, (snapshot) => {
        snapshot.forEach(r => {
          const data = r.val();
          for (let p in data) totals[p] += data[p];
        });
        const winner = Object.entries(totals).sort((a, b) => b[1] - a[1])[0][0];
        wins[winner] = (wins[winner] || 0) + 1;
        renderWins();
      }, { onlyOnce: true });
    }

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    onValue(ref(db, "games"), (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      const gameEntries = Object.entries(data);
      const lastGame = gameEntries[gameEntries.length - 1];
      currentGameId = lastGame[0];
      const game = lastGame[1];
      players = game.players;
      renderGame(game);
    });

    // Ø±Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
    function renderGame(game) {
      // Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ±ÙˆØª
      const totals = {};
      game.players.forEach(p => totals[p] = 0);
      for (let r in game.rounds) {
        const scores = game.rounds[r];
        for (let p in scores) totals[p] += scores[p];
      }
      const sortedPlayers = Object.entries(totals).filter(([p, s]) => s > 0).sort((a, b) => b[1] - a[1]);

      document.getElementById("topPlayers").innerHTML = sortedPlayers.slice(0, 3)
        .map(([p, s]) => `<div class="card"><h3>${p}</h3><p>${s}</p></div>`).join("");

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      const headRow = `<tr><th>Ø§Ù„Ø¬ÙˆÙ„Ø©</th>${game.players.map(p => `<th>${p}</th>`).join("")}</tr>`;
      document.getElementById("scoreHead").innerHTML = headRow;

      let bodyHTML = "";
      let roundIndex = Object.keys(game.rounds || {}).length;

      for (let r in game.rounds) {
        const scores = game.rounds[r];
        bodyHTML = `
          <tr>
            <td>Ø¬ÙˆÙ„Ø© ${roundIndex}</td>
            ${game.players.map(p => `<td>${scores[p] || 0}</td>`).join("")}
            <td><button class="btn-edit" onclick='editRound("${r}", ${JSON.stringify(scores)})'>âœï¸</button></td>
          </tr>
        ` + bodyHTML;
        roundIndex--;
      }

      // ØµÙ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      if (!game.finished) {
        bodyHTML = `
          <tr>
            <td>â•</td>
            ${game.players.map(p => `<td><input id="input-${p}" type="number" style="width:50px"></td>`).join("")}
            <td><button class="btn" onclick="addRound()">â• Ø£Ø¶Ù Ø¬ÙˆÙ„Ø©</button></td>
          </tr>
        ` + bodyHTML;
      }

      document.getElementById("scoreBody").innerHTML = bodyHTML;
    }

    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ²
    function renderWins() {
      const sorted = Object.entries(wins).sort((a, b) => b[1] - a[1]);
      document.querySelector("#winsTable tbody").innerHTML = sorted
        .map(([p, w]) => `<tr><td>${p}</td><td>${w}</td></tr>`).join("");
    }

    // Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† HTML
    window.startNewGame = startNewGame;
    window.addRound = addRound;
    window.editRound = editRound;
    window.endGame = endGame;
  </script>
</body>
</html>
